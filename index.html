// Código de login, verificación y navegación de secciones
let usuarioActual = null;

const links = document.querySelectorAll('.nav-link');
links.forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    const destino = link.getAttribute('data-target');
    document.querySelectorAll('main .section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(destino).classList.add('active');
  });
});

let clientes = JSON.parse(localStorage.getItem('clientes')) || [];
let insumos = JSON.parse(localStorage.getItem('insumos')) || [];

function actualizarClientes() {
  const tbody = document.querySelector('#tablaClientes tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  clientes.forEach((cliente, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${cliente.nombre}</td>
      <td>${cliente.email}</td>
      <td><button onclick="eliminarCliente(${i})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
  const totalClientes = document.getElementById('totalClientes');
  if (totalClientes) totalClientes.textContent = clientes.length;
}

function eliminarCliente(index) {
  clientes.splice(index, 1);
  localStorage.setItem('clientes', JSON.stringify(clientes));
  actualizarClientes();
}

const formClientes = document.getElementById('formClientes');
if (formClientes) {
  formClientes.addEventListener('submit', function(e) {
    e.preventDefault();
    const nombre = document.getElementById('clienteNombre').value;
    const email = document.getElementById('clienteEmail').value;
    clientes.push({ nombre, email });
    localStorage.setItem('clientes', JSON.stringify(clientes));
    actualizarClientes();
    formClientes.reset();
  });
}

function actualizarInsumos() {
  const lista = document.getElementById('listaInsumos');
  if (!lista) return;
  lista.innerHTML = '';
  insumos.forEach((insumo, i) => {
    const li = document.createElement('li');
    li.textContent = `${insumo.nombre} (${insumo.cantidad})`;
    lista.appendChild(li);
  });
  const totalInsumos = document.getElementById('totalInsumos');
  if (totalInsumos) totalInsumos.textContent = insumos.length;
}

const formInsumos = document.getElementById('formInsumos');
if (formInsumos) {
  formInsumos.addEventListener('submit', function(e) {
    e.preventDefault();
    const nombre = document.getElementById('insumoNombre').value;
    const cantidad = document.getElementById('insumoCantidad').value;
    insumos.push({ nombre, cantidad });
    localStorage.setItem('insumos', JSON.stringify(insumos));
    actualizarInsumos();
    formInsumos.reset();
  });
}

function mostrarRegistro() {
  document.getElementById('login').classList.remove('active');
  document.getElementById('registro').classList.add('active');
  document.getElementById('confirmacion').classList.remove('active');
}

function mostrarLogin() {
  document.getElementById('login').classList.add('active');
  document.getElementById('registro').classList.remove('active');
  document.getElementById('confirmacion').classList.remove('active');
}

function mostrarConfirmacion() {
  document.getElementById('confirmacion').classList.add('active');
  document.getElementById('registro').classList.remove('active');
  document.getElementById('login').classList.remove('active');
}

function verificarCodigo() {
  const ingresado = document.getElementById('codigoVerificacion').value;
  const usuarioGuardado = JSON.parse(localStorage.getItem('usuario'));
  if (usuarioGuardado && usuarioGuardado.codigo === ingresado) {
    usuarioGuardado.verificado = true;
    delete usuarioGuardado.codigo;
    localStorage.setItem('usuario', JSON.stringify(usuarioGuardado));
    alert('Cuenta verificada');
    mostrarLogin();
  } else {
    alert('Código incorrecto');
  }
}

document.getElementById('registroForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const nombre = document.getElementById('registroNombre').value;
  const email = document.getElementById('registroEmail').value;
  const password = document.getElementById('registroPassword').value;
  const codigo = Math.floor(100000 + Math.random() * 900000);
  const usuario = { nombre, email, password, verificado: false, codigo };
  localStorage.setItem('usuario', JSON.stringify(usuario));
  alert('Tu código es: ' + codigo);
  mostrarConfirmacion();
});

document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const recordarme = document.getElementById('recordarme').checked;
  const usuarioGuardado = JSON.parse(localStorage.getItem('usuario'));
  if (usuarioGuardado && usuarioGuardado.email === email && usuarioGuardado.password === password) {
    if (!usuarioGuardado.verificado) {
      alert('Falta confirmar código');
      mostrarConfirmacion();
    } else {
      if (recordarme) localStorage.setItem('sesionActiva', 'true');
      localStorage.setItem('usuarioActivo', JSON.stringify(usuarioGuardado));
      usuarioActual = usuarioGuardado;
      iniciarSesion();
    }
  } else {
    alert('Datos incorrectos');
  }
});

function iniciarSesion() {
  usuarioActual = JSON.parse(localStorage.getItem('usuarioActivo'));
  document.getElementById('login').classList.remove('active');
  document.querySelector('header').style.display = 'flex';
  document.querySelector('main').style.display = 'block';
  document.getElementById('inicio').classList.add('active');
  const bienvenida = document.createElement('p');
  bienvenida.textContent = `¡Bienvenido/a, ${usuarioActual.nombre}!`;
  document.getElementById('inicio').prepend(bienvenida);
  actualizarClientes();
  actualizarInsumos();
}

function cerrarSesion() {
  localStorage.removeItem('usuarioActivo');
  localStorage.removeItem('sesionActiva');
  location.reload();
}

if (localStorage.getItem('sesionActiva') === 'true') {
  iniciarSesion();
}
