<script>
  let usuarioActual = null;

  document.getElementById('loginForm').insertAdjacentHTML('beforeend', '<br><label><input type="checkbox" id="recordarme"> Recordarme</label>');

  // Registro con nombre
  document.getElementById('registroForm').insertAdjacentHTML('afterbegin', '<label>Nombre completo:<br><input type="text" id="registroNombre" required></label><br>');

  const registroForm = document.getElementById('registroForm');
  registroForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const nombre = document.getElementById('registroNombre').value;
    const email = document.getElementById('registroEmail').value;
    const password = document.getElementById('registroPassword').value;
    const codigo = generarCodigo();
    const usuario = { nombre, email, password, verificado: false, codigo };
    localStorage.setItem('usuario', JSON.stringify(usuario));
    alert('Código de verificación: ' + codigo);
    mostrarConfirmacion();
  });

  const loginForm = document.getElementById('loginForm');
  loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const recordarme = document.getElementById('recordarme').checked;
    const usuarioGuardado = JSON.parse(localStorage.getItem('usuario'));
    if (usuarioGuardado && usuarioGuardado.email === email && usuarioGuardado.password === password) {
      if (!usuarioGuardado.verificado && usuarioGuardado.codigo) {
        alert('Por favor confirmá tu correo con el código.');
        mostrarConfirmacion();
      } else {
        if (recordarme) localStorage.setItem('sesionActiva', 'true');
        localStorage.setItem('usuarioActivo', JSON.stringify(usuarioGuardado));
        usuarioActual = usuarioGuardado;
        iniciarSesion();
      }
    } else {
      alert('Usuario o contraseña incorrectos');
    }
  });

  function iniciarSesion() {
    usuarioActual = JSON.parse(localStorage.getItem('usuarioActivo')) || {};
    document.getElementById('login').classList.remove('active');
    document.querySelector('header').style.display = 'flex';
    document.querySelector('main').style.display = 'block';
    document.getElementById('inicio').classList.add('active');
    const bienvenida = document.createElement('p');
    bienvenida.textContent = `¡Bienvenido/a, ${usuarioActual.nombre}!`;
    bienvenida.style.fontWeight = 'bold';
    document.getElementById('inicio').prepend(bienvenida);
  }

  function cerrarSesion() {
    alert('Sesión cerrada');
    localStorage.removeItem('sesionActiva');
    localStorage.removeItem('usuarioActivo');
    document.querySelector('header').style.display = 'none';
    document.querySelector('main').style.display = 'none';
    document.getElementById('login').classList.add('active');
  }

  function generarCodigo() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  function mostrarLogin() {
    document.getElementById('login').classList.add('active');
    document.getElementById('registro').classList.remove('active');
    document.getElementById('confirmacion').classList.remove('active');
  }

  function mostrarRegistro() {
    document.getElementById('registro').classList.add('active');
    document.getElementById('login').classList.remove('active');
    document.getElementById('confirmacion').classList.remove('active');
  }

  function mostrarConfirmacion() {
    document.getElementById('confirmacion').classList.add('active');
    document.getElementById('registro').classList.remove('active');
    document.getElementById('login').classList.remove('active');
  }

  function verificarCodigo() {
    const ingresado = document.getElementById('codigoVerificacion').value;
    const usuarioGuardado = JSON.parse(localStorage.getItem('usuario'));
    if (usuarioGuardado && usuarioGuardado.codigo === ingresado) {
      usuarioGuardado.verificado = true;
      delete usuarioGuardado.codigo;
      localStorage.setItem('usuario', JSON.stringify(usuarioGuardado));
      alert('Cuenta verificada con éxito');
      mostrarLogin();
    } else {
      alert('Código incorrecto');
    }
  }

  window.addEventListener('load', () => {
    if (localStorage.getItem('sesionActiva') === 'true') {
      usuarioActual = JSON.parse(localStorage.getItem('usuarioActivo')) || {};
      iniciarSesion();
    }
  });
</script>
