let menu = [], clientes = [], pedidos = [], insumos = [];

function generateId() {
  return Date.now() + "" + Math.floor(Math.random() * 1000);
}

function loadData() {
  menu = JSON.parse(localStorage.getItem("menu")) || [];
  clientes = JSON.parse(localStorage.getItem("clientes")) || [];
  pedidos = JSON.parse(localStorage.getItem("pedidos")) || [];
  insumos = JSON.parse(localStorage.getItem("insumos")) || [];
}

function saveData() {
  localStorage.setItem("menu", JSON.stringify(menu));
  localStorage.setItem("clientes", JSON.stringify(clientes));
  localStorage.setItem("pedidos", JSON.stringify(pedidos));
  localStorage.setItem("insumos", JSON.stringify(insumos));
}

function renderMenu() {
  const tbody = document.querySelector("#tabla-menu tbody");
  tbody.innerHTML = "";
  menu.forEach(plato => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${plato.nombre}</td>
      <td>$${plato.precio}</td>
      <td>${plato.descripcion}</td>
      <td><button onclick="eliminarPlato('${plato.id}')">Borrar</button></td>
    `;
    tbody.appendChild(tr);
  });
  const selectPlato = document.getElementById("pedido-plato");
  selectPlato.innerHTML = "";
  menu.forEach(plato => {
    const opt = document.createElement("option");
    opt.value = plato.id;
    opt.textContent = plato.nombre;
    selectPlato.appendChild(opt);
  });
}

function eliminarPlato(id) {
  menu = menu.filter(p => p.id !== id);
  saveData(); renderMenu(); renderPedidos(); renderReportes();
}

function renderClientes() {
  const tbody = document.querySelector("#tabla-clientes tbody");
  tbody.innerHTML = "";
  clientes.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.nombre}</td>
      <td>${c.telefono}</td>
      <td>${c.direccion}</td>
      <td><button onclick="eliminarCliente('${c.id}')">Borrar</button></td>
    `;
    tbody.appendChild(tr);
  });
  const selectCliente = document.getElementById("pedido-cliente");
  selectCliente.innerHTML = "";
  clientes.forEach(cliente => {
    const opt = document.createElement("option");
    opt.value = cliente.id;
    opt.textContent = cliente.nombre;
    selectCliente.appendChild(opt);
  });
}

function eliminarCliente(id) {
  if (pedidos.some(p => p.clienteId === id)) {
    alert("No se puede eliminar, tiene pedidos.");
    return;
  }
  clientes = clientes.filter(c => c.id !== id);
  saveData(); renderClientes(); renderReportes();
}

function renderPedidos() {
  const tbody = document.querySelector("#tabla-pedidos tbody");
  tbody.innerHTML = "";
  pedidos.forEach(p => {
    const cliente = clientes.find(c => c.id === p.clienteId);
    const plato = menu.find(m => m.id === p.platoId);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${cliente?.nombre || "?"}</td>
      <td>${plato?.nombre || "?"}</td>
      <td>${p.estado}</td>
      <td><button onclick="eliminarPedido('${p.id}')">Borrar</button></td>
    `;
    tbody.appendChild(tr);
  });

  const listaProx = document.getElementById("lista-proximos-pedidos");
  listaProx.innerHTML = "";
  pedidos.filter(p => p.estado !== "Entregado").slice(0, 3).forEach(p => {
    const cliente = clientes.find(c => c.id === p.clienteId);
    const li = document.createElement("li");
    li.textContent = `${cliente?.nombre || "?"} - ${p.estado}`;
    listaProx.appendChild(li);
  });
}

function eliminarPedido(id) {
  pedidos = pedidos.filter(p => p.id !== id);
  saveData(); renderPedidos(); renderReportes();
}

function renderInsumos() {
  const tbody = document.querySelector("#tabla-insumos tbody");
  tbody.innerHTML = "";
  insumos.forEach(i => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i.nombre}</td>
      <td>${i.cantidad}</td>
      <td>${i.unidad}</td>
      <td><button onclick="eliminarInsumo('${i.id}')">Borrar</button></td>
    `;
    tbody.appendChild(tr);
  });
}

function eliminarInsumo(id) {
  insumos = insumos.filter(i => i.id !== id);
  saveData(); renderInsumos(); renderReportes();
}

function renderReportes() {
  document.getElementById("reporte-total-clientes").textContent = `Total de clientes: ${clientes.length}`;
  document.getElementById("reporte-total-menu").textContent = `Total de platos en el menú: ${menu.length}`;
  document.getElementById("reporte-total-pedidos").textContent = `Total de pedidos: ${pedidos.length}`;
  document.getElementById("reporte-total-insumos").textContent = `Total de insumos: ${insumos.length}`;

  let totalVentas = 0;
  pedidos.filter(p => p.estado === "Entregado").forEach(p => {
    const plato = menu.find(m => m.id === p.platoId);
    if (plato) totalVentas += Number(plato.precio);
  });
  document.getElementById("ventas-hoy").textContent = `Total de ventas hoy: $${totalVentas}`;
  document.getElementById("ventas-semana").textContent = `Resumen semanal: $${totalVentas}`;

  const conteo = {};
  pedidos.filter(p => p.estado === "Entregado").forEach(p => {
    conteo[p.platoId] = (conteo[p.platoId] || 0) + 1;
  });
  const topUl = document.getElementById("top-platos");
  topUl.innerHTML = "";
  Object.entries(conteo).sort((a, b) => b[1] - a[1]).slice(0, 3).forEach(([id, count]) => {
    const plato = menu.find(m => m.id === id);
    if (plato) {
      const li = document.createElement("li");
      li.textContent = `${plato.nombre} (vendidos: ${count})`;
      topUl.appendChild(li);
    }
  });
}

document.getElementById("form-menu").addEventListener("submit", e => {
  e.preventDefault();
  const nombre = document.getElementById("menu-nombre").value.trim();
  const precio = parseFloat(document.getElementById("menu-precio").value);
  const descripcion = document.getElementById("menu-descripcion").value.trim();
  menu.push({ id: generateId(), nombre, precio, descripcion });
  saveData(); renderMenu(); e.target.reset();
});

document.getElementById("form-clientes").addEventListener("submit", e => {
  e.preventDefault();
  const nombre = document.getElementById("cliente-nombre").value.trim();
  const telefono = document.getElementById("cliente-telefono").value.trim();
  const direccion = document.getElementById("cliente-direccion").value.trim();
  clientes.push({ id: generateId(), nombre, telefono, direccion });
  saveData(); renderClientes(); e.target.reset();
});

document.getElementById("form-insumos").addEventListener("submit", e => {
  e.preventDefault();
  const nombre = document.getElementById("insumo-nombre").value.trim();
  const cantidad = parseFloat(document.getElementById("insumo-cantidad").value);
  const unidad = document.getElementById("insumo-unidad").value.trim();
  insumos.push({ id: generateId(), nombre, cantidad, unidad });
  saveData(); renderInsumos(); e.target.reset();
});

document.getElementById("form-pedidos").addEventListener("submit", e => {
  e.preventDefault();
  const clienteId = document.getElementById("pedido-cliente").value;
  const platoId = document.getElementById("pedido-plato").value;
  const estado = document.getElementById("pedido-estado").value;
  pedidos.push({ id: generateId(), clienteId, platoId, estado });
  saveData(); renderPedidos(); renderReportes(); e.target.reset();
});

document.getElementById("btnEntrarSesion").addEventListener("click", () => {
  alert("Sesión iniciada (simulado).");
  sections.forEach(sec => sec.style.display = "none");
  document.getElementById("seccion-inicio").style.display = "block";
});

const mensajeSalida = document.getElementById("mensaje-salida");
if (mensajeSalida) {
  const fechaActual = new Date();
  mensajeSalida.textContent = `Tu sesión finalizó el ${fechaActual.toLocaleDateString()} a las ${fechaActual.toLocaleTimeString()}`;
}

// Inicializar todo
loadData();
renderMenu();
renderClientes();
renderInsumos();
renderPedidos();
renderReportes();
